{% extends 'base.html.twig' %}
{% block body %}

	<div class="container mt-4">
		<div class="row justify-content-center">
			<div class="col-md-8">
				<div class="card">
					<div class="card-header">
						{{ post.user.username }}
					</div>
					<div class="card-body">
						{% for imagePost in post.imagePosts %}
							<img src="/uploads/images/{{ imagePost.image.image }}" class="card-img-top" alt="Post image" width="100">
						{% endfor %}

						<h3 class="card-title">{{ post.title }}</h3>
						<p class="card-text">{{ post.body }}</p>
						<p class="text-muted">Posted on:
							{{ post.createdAt|date('M d, Y') }}</p>
					</div>
					<div class="card-footer bg-light text-muted">
						{% if app.user and app.user.id == post.user.id %}
							{# Manually append the returnUrl query parameter to the URL #}
							<a href="{{ path('app_post_edit', {'id': post.id}) }}?returnUrl={{ app.request.uri|url_encode }}" class="btn btn-primary">
								<i class="bi bi-pencil"></i>
								Modifier
							</a>
							{{ include('post/_delete_form.html.twig') }}
							<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#commentModal">
								<i class="fa-solid fa-comment"></i>
								Comment
							</button>
						{% endif %}
						{% if app.user %}
							{% set userLike = post.likes|filter(like => like.user == app.user and not like.superlike) %}
							{% set regularLikesCount = post.likes|filter(like => not like.superlike)|length %}
							{% if userLike|length == 0 %}
								<a href="{{ path('app_post_like', {'id': post.id}) }}" class="btn btn-primary">
									<i class="bi bi-heart"></i>
									{{ regularLikesCount }}
									Like
								</a>
							{% else %}
								<a href="{{ path('app_post_unlike', {'id': post.id}) }}" class="btn btn-danger">
									<i class="bi bi-heart-fill"></i>
									{{ regularLikesCount }}
									Unlike
								</a>
							{% endif %}
						{% endif %}
						{% if app.user %}
							{% set userSuperlike = post.likes|filter(like => like.user == app.user and like.superlike) %}
							{% set superLikesCount = post.likes|filter(like => like.superlike)|length %}
							{% if userSuperlike|length == 0 %}
								<a href="{{ path('app_post_superlike', {'id': post.id}) }}" class="btn btn-info">
									<i class="bi bi-star"></i>
									{{ superLikesCount }}
									Superlike
								</a>
							{% else %}
								<a href="{{ path('app_post_superunlike', {'id': post.id}) }}" class="btn btn-secondary">
									<i class="bi bi-star-fill"></i>
									{{ superLikesCount }}
									Superlike
								</a>
							{% endif %}
						{% endif %}
						<!-- Report post -->
						<a href="#" class="btn btn-danger" data-toggle="modal" data-target="#reportModalPost">Signaler</a>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="modal fade" id="commentModal" tabindex="-1" role="dialog" aria-labelledby="commentModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="commentModalLabel">Add a Comment</h5>
					<button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body"></div>
			</div>
		</div>
	</div>
		<!-- Report Post Modal -->
		<div class="modal fade" id="reportModalPost" tabindex="-1" role="dialog" aria-labelledby="reportModalPostLabel" aria-hidden="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="reportModalPostLabel">Report un Post</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						{{ render(controller('App\\Controller\\PostController::reportPost', {'id': post.id})) }}
					</div>
				</div>
			</div>
		</div>
		<!-- Success Modal HTML -->
		<div class="modal fade" id="successModal" tabindex="-1" role="dialog" aria-labelledby="successModalLabel" aria-hidden="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="successModalLabel">Report</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						Le report a été envoyé avec succès!
					</div>
				</div>
			</div>
		</div>

	<script>
		document.addEventListener('DOMContentLoaded', function () {
			const urlParams = new URLSearchParams(window.location.search);
			if (urlParams.has('error')) {
				if (urlParams.get('error') === 'superlike_limit') {
					alert('Tu ne peux pas superliker plus d\'une fois par semaine!');
					// Remove the query parameters from the URL
					window.history.replaceState({}, document.title, window.location.pathname);
				}
			}
		});
		$(document).ready(function () { // Trigger modal open
			$('.btn[data-target="#reportModalPost"]').click(function () {
				$('#reportModalPost').modal('show');
			});

			$('.close').on('click', function () {
				$('#reportModalPost').modal('hide');
			});
		});
	</script>
{% endblock %}
	{% block javascripts %}
	{{ parent() }}
	<script>
	$(document).ready(function() {
		// Function to parse query parameters from the URL
		function getQueryParam(param) {
			var result = new RegExp('[\?&]' + param + '=([^&#]*)').exec(window.location.href);
			return result ? decodeURIComponent(result[1].replace(/\+/g, ' ')) : false;
		}

		// Function to remove a specific query parameter
		function removeQueryParam(parameter) {
			var url = document.location.href;
			var urlparts = url.split('?');
			
			if (urlparts.length >= 2) {
				var prefix = encodeURIComponent(parameter) + '=';
				var pars = urlparts[1].split(/[&;]/g);

				// Loop through query strings, exclude target query param
				for (var i = pars.length; i-- > 0;) {
					if (pars[i].lastIndexOf(prefix, 0) !== -1) {
						pars.splice(i, 1);
					}
				}

				// Rejoin the URL without the target parameter
				url = urlparts[0] + (pars.length > 0 ? '?' + pars.join('&') : '');
				history.replaceState(null, document.title, url); // Replace the state in the history
			}
		}

		// Check for 'success' query parameter and show modal if present
		var success = getQueryParam('success');
		if (success) {
			$('#successModal').modal('show');
			removeQueryParam('success');  // Remove 'success' from URL
		}

		// Setup triggers for modals
		$('.btn[data-target="#reportModalPost"]').click(function() {
			$('#reportModalPost').modal('show');
		});

		$('.close').on('click', function() {
			$('#reportModalPost').modal('hide');
			$('#successModal').modal('hide');
		});
	});
	</script>
	{% endblock %}

